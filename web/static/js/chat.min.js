document.addEventListener("DOMContentLoaded",(function(){const t=document.getElementById("chatForm"),e=document.getElementById("chatInput"),n=document.getElementById("chatMessages"),a=document.getElementById("newChatBtn"),o=document.getElementById("historyList");let c=null;async function s(){try{const t=await fetch("/api/chats");if(!t.ok)return;const e=await t.json();o.innerHTML="",e&&e.forEach((t=>function(t,e){const n=document.createElement("div");n.className="history-item",n.setAttribute("data-chat-id",e);const s=document.createElement("a");s.href=`/chat?id=${e}`,s.textContent=t;const i=document.createElement("button");i.className="delete-chat-btn",i.innerHTML="&times;",i.title="Delete chat",i.onclick=t=>{t.preventDefault(),t.stopPropagation(),confirm("Are you sure you want to delete this chat?")&&async function(t,e){try{(await fetch(`/api/chats/${t}`,{method:"DELETE"})).ok?(e.remove(),c==t&&a.click()):alert("Failed to delete chat.")}catch(t){console.error("Failed to delete chat:",t)}}(e,n)},n.appendChild(s),n.appendChild(i),o.prepend(n)}(t.Title,t.ID)))}catch(t){console.error("Failed to load history:",t)}}async function i(t){if(!t)return n.innerHTML="",c=null,void document.querySelectorAll(".history-item.active").forEach((t=>t.classList.remove("active")));try{const e=await fetch(`/api/chats/${t}/messages`);if(!e.ok)return void(window.location.href="/chat");const a=await e.json();n.innerHTML="",a&&a.forEach((t=>{r(t.Content||t.content,t.Role||t.role)})),c=t,document.querySelectorAll(".history-item.active").forEach((t=>t.classList.remove("active")));const o=document.querySelector(`.history-item[data-chat-id='${t}']`);o&&o.classList.add("active")}catch(t){console.error("Failed to load chat:",t)}}function r(t,e){const a=document.createElement("li");a.className=`msg ${e}`;const o=document.createElement("span");o.className="avatar",o.textContent="user"===e?"You":"AI";const c=document.createElement("p");c.textContent=t,a.appendChild(o),a.appendChild(c),n.appendChild(a),n.scrollTop=n.scrollHeight}function l(a){const o=document.getElementById("loadingIndicator");if(a){if(e.disabled=!0,t.querySelector("button").disabled=!0,!o){const t=document.createElement("div");t.id="loadingIndicator",t.className="msg assistant",t.innerHTML='<span class="avatar">AI</span><p><span class="spinner"></span></p>',n.appendChild(t),n.scrollTop=n.scrollHeight}}else e.disabled=!1,t.querySelector("button").disabled=!1,o&&o.remove(),e.focus()}t.addEventListener("submit",(async function(t){t.preventDefault();const n=e.value.trim();if(!n)return;r(n,"user"),e.value="",e.dir="ltr",e.style.height="auto",l(!0);const a=c?`/api/chats/${c}/messages`:"/api/chats";try{let t={content:n};null!=c&&(t.chat_id=c);const e=await fetch(a,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});l(!1);const o=await e.json();o.reply?r(o.reply,"assistant"):o.error&&r(o.error,"assistant"),o.chat&&!c&&(await s(),window.history.pushState({},"",`/chat?id=${o.chat.ID}`),i(o.chat.ID))}catch(t){l(!1),r("Sorry, a server error occurred.","assistant")}})),o.addEventListener("click",(function(t){t.preventDefault();const e=t.target.closest(".history-item");if(e){const t=e.getAttribute("data-chat-id");t!==c&&(window.history.pushState({},"",`/chat?id=${t}`),i(t))}})),a.addEventListener("click",(t=>{t.preventDefault(),null!==c&&(window.history.pushState({},"","/chat"),i(null))})),e.addEventListener("input",(()=>{e.dir=/[\u0600-\u06FF\u0750-\u077F]/.test(e.value)?"rtl":"ltr",e.style.height="auto",e.style.height=e.scrollHeight+"px"}));const d=new URLSearchParams(window.location.search).get("id");s().then((()=>{d&&i(d)}))}));