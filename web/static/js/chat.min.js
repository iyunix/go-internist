document.addEventListener("DOMContentLoaded",function(){const t=document.getElementById("chatForm"),e=document.getElementById("chatInput"),a=document.getElementById("chatMessages"),n=document.getElementById("newChatBtn"),r=document.getElementById("historyList");let i=null;async function s(){try{const t=await fetch("/api/chats");if(!t.ok)return;const e=await t.json();r.innerHTML="",e&&e.forEach((t=>o(t.Title,t.ID)))}catch(t){console.error("Failed to load history:",t)}}async function l(t){if(!t)return a.innerHTML="",i=null,document.querySelectorAll(".history-item.active").forEach((t=>t.classList.remove("active")));try{const e=await fetch(`/api/chats/${t}/messages`);if(!e.ok)return void(window.location.href="/chat");const s=await e.json();a.innerHTML="",s&&s.forEach((t=>u(t.Content,t.Role))),i=t,document.querySelectorAll(".history-item.active").forEach((t=>t.classList.remove("active")));const l=document.querySelector(`.history-item[data-chat-id='${t}']`);l&&l.classList.add("active")}catch(t){console.error("Failed to load chat:",t)}}function u(t,e){const n=document.createElement("li");n.className=`msg ${e}`;const r=document.createElement("span");r.className="avatar",r.textContent="user"===e?"You":"AI";const i=document.createElement("p");i.textContent=t,n.appendChild(r),n.appendChild(i),a.appendChild(n),a.scrollTop=a.scrollHeight}function o(t,e){const a=document.createElement("div");a.className="history-item",a.setAttribute("data-chat-id",e);const i=document.createElement("a");i.href=`/chat?id=${e}`,i.textContent=t;const s=document.createElement("button");s.className="delete-chat-btn",s.innerHTML="&times;",s.title="Delete chat",s.onclick=n=>{n.preventDefault(),n.stopPropagation(),confirm("Are you sure you want to delete this chat?")&&d(e,a)},a.appendChild(i),a.appendChild(s),r.prepend(a)}async function d(t,e){try{const a=await fetch(`/api/chats/${t}`,{method:"DELETE"});a.ok?(e.remove(),i==t&&n.click()):alert("Failed to delete chat.")}catch(a){console.error("Failed to delete chat:",a)}}function c(n){const r=document.getElementById("loadingIndicator");n?(e.disabled=!0,t.querySelector("button").disabled=!0,r||(function(){const n=document.createElement("div");n.id="loadingIndicator",n.className="msg assistant",n.innerHTML=`<span class="avatar">AI</span><p><span class="spinner"></span></p>`,a.appendChild(n),a.scrollTop=a.scrollHeight}())):(e.disabled=!1,t.querySelector("button").disabled=!1,r&&r.remove(),e.focus())}t.addEventListener("submit",async function(r){r.preventDefault();const s=e.value.trim();if(!s)return;u(s,"user");const o=e.value;e.value="",e.dir="ltr",e.style.height="auto",c(!0);const d=i?`/api/chats/${i}/messages`:"/api/chats";try{const r=await fetch(d,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:o})});c(!1);const e=await r.json();e.reply?u(e.reply,"assistant"):e.error&&u(e.error,"assistant"),e.chat&&!i&&(await s(),window.history.pushState({},``,`/chat?id=${e.chat.ID}`),l(e.chat.ID))}catch(t){c(!1),u("Sorry, a server error occurred.","assistant")}}),r.addEventListener("click",function(t){t.preventDefault();const e=t.target.closest(".history-item");if(e){const a=e.getAttribute("data-chat-id");a!==i&&(window.history.pushState({},``,`/chat?id=${a}`),l(a))}}),n.addEventListener("click",t=>{t.preventDefault();null!==i&&(window.history.pushState({},``,`/chat`),l(null))}),e.addEventListener("input",()=>{const t=/[\u0600-\u06FF\u0750-\u077F]/;e.dir=t.test(e.value)?"rtl":"ltr",e.style.height="auto",e.style.height=e.scrollHeight+"px"});const m=new URLSearchParams(window.location.search).get("id");s().then(()=>{m&&l(m)})});
