document.addEventListener("DOMContentLoaded",(function(){const t=document.getElementById("chatForm"),e=document.getElementById("chatInput"),a=document.getElementById("chatMessages"),n=document.getElementById("newChatBtn"),o=document.getElementById("historyList");let c=new URLSearchParams(window.location.search).get("id");function s(a){e.disabled=a,t.querySelector("button").disabled=a}function r(t,e,n=!1){const o=document.createElement("li");o.className=`msg ${e}`;const c=document.createElement("span");c.className="avatar",c.textContent="user"===e?"You":"AI";const s=document.createElement("p");if(s.textContent=t,o.appendChild(c),o.appendChild(s),a.appendChild(o),a.scrollTop=a.scrollHeight,n)return o}async function i(){try{const t=await fetch("/api/chats");if(!t.ok)return;const e=await t.json();o.innerHTML="",e&&(e.forEach((t=>{const e=document.createElement("div");e.className="history-item",e.setAttribute("data-chat-id",t.ID),e.innerHTML=`<a href="/chat?id=${t.ID}">${t.Title}</a><button class="delete-chat-btn" title="Delete chat">&times;</button>`,o.prepend(e)})),d(c))}catch(t){console.error("Failed to load history:",t)}}async function l(t){if(!t)return a.innerHTML="",void(c=null);try{const e=await fetch(`/api/chats/${t}/messages`);if(!e.ok)return void(window.location.href="/chat");const n=await e.json();a.innerHTML="",n&&n.forEach((t=>r(t.Content,t.Role))),c=t,d(t)}catch(t){console.error("Failed to load messages:",t)}}function d(t){if(document.querySelectorAll(".history-item.active").forEach((t=>t.classList.remove("active"))),t){const e=document.querySelector(`.history-item[data-chat-id='${t}']`);e&&e.classList.add("active")}}t.addEventListener("submit",(async function(t){t.preventDefault();const n=e.value.trim();if(!n)return;r(n,"user"),e.value="",s(!0);let o=c;if(!o)try{const t=await fetch("/api/chats",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:n})});if(!t.ok)throw new Error(`Failed to create chat: ${t.statusText}`);o=(await t.json()).ID,window.history.pushState({chatId:o},"",`/chat?id=${o}`),await i(),d(o)}catch(t){return console.error(t),r("Error: Could not create a new chat session.","assistant"),void s(!1)}const l=r("","assistant",!0),h=new EventSource(`/api/chats/${o}/stream?q=${encodeURIComponent(n)}`);h.onmessage=t=>{l.querySelector("p").textContent+=t.data,a.scrollTop=a.scrollHeight},h.onerror=t=>{console.error("EventSource failed:",t),r("A streaming error occurred. Please try again.","assistant"),h.close(),s(!1)},h.addEventListener("done",(()=>{console.log("Stream successfully completed by server."),h.close(),s(!1)}))})),n.addEventListener("click",(t=>{t.preventDefault(),c&&(window.history.pushState({},"","/chat"),l(null))})),o.addEventListener("click",(async t=>{if(t.target.classList.contains("delete-chat-btn")){t.preventDefault();const e=t.target.closest(".history-item"),a=e.getAttribute("data-chat-id");if(confirm("Are you sure you want to delete this chat?"))try{(await fetch(`/api/chats/${a}`,{method:"DELETE"})).ok&&(e.remove(),a===c&&n.click())}catch(t){console.error("Failed to delete chat",t)}}else if("A"===t.target.tagName){t.preventDefault();const e=t.target.closest(".history-item").getAttribute("data-chat-id");e!==c&&(window.history.pushState({chatId:e},"",t.target.href),l(e))}})),i().then((()=>{c&&l(c)}))}));