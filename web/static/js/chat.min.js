document.addEventListener("DOMContentLoaded",(function(){const e=document.getElementById("chatForm"),t=document.getElementById("chatInput"),a=document.getElementById("chatMessages"),r=document.getElementById("newChatBtn"),n=document.getElementById("historyList");let o=new URLSearchParams(window.location.search).get("id");function s(a){t.disabled=a,e.querySelector("button").disabled=a}function i(e,t,r=!1){const n=document.createElement("li");n.className=`msg ${t}`;const o=document.createElement("span");o.className="avatar",o.textContent="user"===t?"You":"AI";const s=document.createElement("assistant"===t?"div":"p");if("assistant"===t)try{window.MarkdownRenderer?.render(s,e||"")}catch(t){s.textContent=e||""}else s.textContent=e||"";if(n.appendChild(o),n.appendChild(s),a.appendChild(n),a.scrollTop=a.scrollHeight,r)return n}async function c(){try{const e=await fetch("/api/chats",{method:"GET",credentials:"same-origin",cache:"no-store"});if(!e.ok)throw new Error(`Failed to load history: ${e.statusText}`);const t=await e.json();n.innerHTML="",Array.isArray(t)&&(t.forEach((e=>{const t=String(e.ID??e.id??""),a=String(e.Title??e.title??"Untitled");if(!t)return;const r=document.createElement("li");r.className="history-item",r.setAttribute("data-chat-id",t),r.innerHTML=`<a href="/chat?id=${t}">${a}</a><button class="delete-chat-btn" title="Delete chat" aria-label="Delete chat">&times;</button>`,n.appendChild(r)})),l(o))}catch(e){console.error("Failed to load history:",e),h("error","Failed to load chat history",{errorMessage:e.message,stack:e.stack})}}async function d(e){if(!e)return a.innerHTML="",o=null,void l(null);try{const t=await fetch(`/api/chats/${e}/messages`,{method:"GET",credentials:"same-origin",cache:"no-store"});if(!t.ok)return void(window.location.href="/chat");const r=await t.json();a.innerHTML="",Array.isArray(r)&&r.length>0&&r.forEach((e=>{const t=e.Role??e.role??"assistant",a=e.Content??e.content??"",r=i("",t,!0).querySelector("assistant"===t?"div":"p");if("assistant"===t)try{window.MarkdownRenderer?.render(r,a)}catch(e){r.textContent=a}else r.textContent=a})),o=e,l(e)}catch(t){console.error("Failed to load messages:",t),h("error","Failed to load messages for chat",{chatId:e,errorMessage:t.message,stack:t.stack})}}function l(e){if(document.querySelectorAll(".history-item.active").forEach((e=>e.classList.remove("active"))),e){const t=document.querySelector(`.history-item[data-chat-id='${e}']`);t&&t.classList.add("active")}}function h(e,t,a){try{"function"==typeof window.logToServer&&window.logToServer(e,t,a)}catch(e){}}e.addEventListener("submit",(async function(e){e.preventDefault();const r=t.value.trim();if(!r)return;i(r,"user"),t.value="",s(!0);let n=o;if(!n)try{const e=document.querySelector("input[name='csrf_token']")?.value||"",t=await fetch("/api/chats",{method:"POST",credentials:"same-origin",cache:"no-store",headers:{"Content-Type":"application/json",...e?{"X-CSRF-Token":e}:{}},body:JSON.stringify({title:r})});if(!t.ok)throw new Error(`Failed to create chat: ${t.statusText}`);const a=await t.json(),o=a.ID??a.id;if(!o)throw new Error("CreateChat response missing id");n=String(o),window.history.pushState({chatId:n},"",`/chat?id=${n}`),await c(),l(n)}catch(e){return console.error(e),h("error","Failed to create new chat",{errorMessage:e.message,stack:e.stack}),i("Error: Could not create a new chat session.","assistant"),void s(!1)}const d=i("","assistant",!0).querySelector("div");let u;try{u=window.MarkdownRenderer?.createStream(d)}catch(e){u={buffer:"",append(e){this.buffer+=String(e),d.textContent=this.buffer},flush(){}}}const m=new EventSource(`/api/chats/${n}/stream?q=${encodeURIComponent(r)}`);m.onmessage=e=>{u.append(e.data),a.scrollTop=a.scrollHeight},m.addEventListener("done",(()=>{m.close(),u.flush?.(),s(!1)})),m.onerror=e=>{console.error("EventSource failed:",e),h("error","EventSource streaming failed",{chatId:n}),i("A streaming error occurred. Please try again.","assistant"),m.close(),s(!1)}})),r.addEventListener("click",(e=>{e.preventDefault(),o&&(window.history.pushState({},"","/chat"),d(null))})),n.addEventListener("click",(async e=>{if(e.target.classList.contains("delete-chat-btn")){e.preventDefault();const t=e.target.closest("li.history-item"),a=t?.getAttribute("data-chat-id");if(!a)return;if(confirm("Are you sure you want to delete this chat?"))try{const e=await fetch(`/api/chats/${a}`,{method:"DELETE",credentials:"same-origin",cache:"no-store"});if(!e.ok)throw new Error(`Failed to delete chat: ${e.statusText}`);t.remove(),a===o&&r.click()}catch(e){console.error("Failed to delete chat",e),h("error","Failed to delete chat",{chatId:a,errorMessage:e.message,stack:e.stack})}}else if("A"===e.target.tagName){e.preventDefault();const t=e.target.closest("li.history-item"),a=t?.getAttribute("data-chat-id");a&&a!==o&&(window.history.pushState({chatId:a},"",e.target.href),d(a))}})),c().then((()=>{o&&d(o)})).catch((e=>{console.error("Error during initial page load:",e),h("error","Error during initial page load sequence",{errorMessage:e.message,stack:e.stack})}))}));