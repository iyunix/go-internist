{{define "styles"}}
  <link rel="stylesheet" href="/static/css/output.css" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet">
{{end}}

{{define "content"}}
  <div class="flex h-screen w-full bg-[var(--background-color)] text-[var(--text-primary)]">
    <aside class="flex w-64 shrink-0 flex-col border-r border-gray-200 bg-[var(--container-bg)]">
      <div class="flex h-16 shrink-0 items-center justify-between border-b border-gray-200 px-4">
        <a href="/chat" class="flex items-center gap-3">
          <div class="flex h-8 w-8 items-center justify-center rounded-lg bg-[var(--primary-color)] text-white">
            <span class="material-symbols-outlined text-xl">health_and_safety</span>
          </div>
          <h1 class="text-xl font-bold">Internist AI</h1>
        </a>
      </div>
      <div class="flex flex-col gap-4 p-4">
        <a href="/chat" id="newChatBtn" class="flex w-full items-center justify-center gap-2 rounded-md bg-[var(--primary-color)] px-3 py-2 text-sm font-medium text-white hover:bg-opacity-90">
          <span class="material-symbols-outlined text-lg">add</span>
          New Chat
        </a>
      </div>
      <div class="flex-1 overflow-y-auto">
        <nav class="flex flex-col px-4">
          <h2 class="mb-2 text-xs font-semibold uppercase text-[var(--text-secondary)]">Previous Chats</h2>
          <div id="historyList" class="flex flex-col space-y-1"></div>
        </nav>
      </div>
      <div class="border-t border-gray-200 p-4">
        <a href="/logout" class="flex w-full items-center gap-3 rounded-md px-3 py-2 text-sm font-medium text-[var(--text-secondary)] hover:bg-gray-100">
          <span class="material-symbols-outlined text-lg">logout</span>
          <span>Logout</span>
        </a>
      </div>
    </aside>
    <div class="flex h-screen w-full flex-col">
      <header class="flex h-16 shrink-0 items-center justify-between border-b border-gray-200 bg-[var(--container-bg)] px-6">
        <div></div>
        <div class="flex items-center gap-4">
          <div class="text-sm text-[var(--text-secondary)]">
            <span id="current-balance">--</span> Credits
          </div>
          <div class="h-10 w-10 rounded-full bg-cover bg-center" style='background-image: url("/static/img/user-avatar.png");'></div>
        </div>
      </header>
      <main class="flex flex-1 flex-col overflow-y-auto">
        <div id="chatMessages" class="mx-auto w-full max-w-4xl flex-1 space-y-8 px-4 py-8 sm:px-6 lg:px-8"></div>
        <div class="sticky bottom-0 bg-[var(--background-color)]/80 backdrop-blur-sm">
          <div class="mx-auto w-full max-w-4xl px-4 py-4 sm:px-6 lg:px-8">
            <form id="chatForm" class="relative">
              <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">
              <textarea id="chatInput" class="w-full rounded-full border-gray-300 bg-[var(--input-bg)] py-3 pl-5 pr-28 text-base text-[var(--text-primary)] placeholder:text-[var(--text-secondary)] focus:border-[var(--primary-color)] focus:ring-[var(--primary-color)]" placeholder="Ask me anything..." rows="1"></textarea>
              <div class="absolute inset-y-0 right-3 flex items-center gap-2">
                <button type="submit" class="flex h-8 w-8 items-center justify-center rounded-full bg-[var(--primary-color)] text-white hover:bg-opacity-90 disabled:bg-gray-400" aria-label="Send message">
                  <span class="material-symbols-outlined text-xl">send</span>
                </button>
              </div>
            </form>
            <small class="mt-2 block text-center text-xs text-gray-500">
              Internist may display inaccurate info; double-check its responses.
            </small>
          </div>
        </div>
      </main>
    </div>
  </div>
{{end}}

{{define "scripts"}}
  <!-- Vendor -->
  <script src="/static/js/vendor/marked.umd.js"></script>
  <script src="/static/js/vendor/purify.min.js"></script>
  <!-- Markdown + utils -->
  <script src="/static/js/markdown_renderer.js"></script>
  <script src="/static/js/logger.js"></script>
  <script src="/static/js/utils.js"></script>
  <!-- Chat app -->
  <script type="module">
    import { ChatAPI } from '/static/js/chat/chat-api.js';
    import { ChatUI }  from '/static/js/chat/chat-ui.js';

    const els = {
      chatMessages: document.getElementById('chatMessages'),
      chatForm:     document.getElementById('chatForm'),
      chatInput:    document.getElementById('chatInput'),
    };

    const api = new ChatAPI();
    const ui  = new ChatUI(els);

    // Example bootstrap: load history then messages for the first chat (adapt for your router/state)
    async function init() {
      const chats = await api.fetchHistory();
      if (!Array.isArray(chats) || chats.length === 0) return;

      const chatId = String(chats[0].id ?? chats[0].ID);
      const messages = await api.fetchMessages(chatId);
      ui.renderMessages(messages);

      // Hook up sending and streaming
      els.chatForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const prompt = els.chatInput.value.trim();
        if (!prompt) return;

        // Show user message immediately
        ui.displayMessage(prompt, 'user', { showLoader: false });

        // Create assistant bubble with a loader
        const assistantLi = ui.displayMessage('', 'assistant', { showLoader: true });
        const bubble = ui.lastAssistantMessageBubble;

        // Stream
        const es = api.createStream(chatId, prompt);
        // Default messages: chunked JSON with {content}
        es.onmessage = (evt) => {
          try {
            const { content } = JSON.parse(evt.data || '{}');
            if (content && window.MarkdownRenderer && bubble) {
              // progressively stream markdown
              const stream = window.MarkdownRenderer.createStream(bubble, { debounceMs: 50 });
              stream.append(content);
            }
          } catch {}
        };
        es.addEventListener('metadata', (evt) => {
          // Handle sources etc. if needed
          // console.log('metadata', evt.data);
        });
        es.addEventListener('error', (evt) => {
          // Render an inline error or toast
        });
        es.addEventListener('complete', (evt) => {
          // finalize UI
        });
        es.addEventListener('done', () => es.close());

        els.chatInput.value = '';
      });
    }

    init();
  </script>

  <script type="module" src="/static/js/chat/chat.js"></script>
  <script src="/static/js/credit-manager.js"></script>
{{end}}
