{{define "title"}}Internist AI - Chat{{end}}

{{define "content"}}
<div class="flex h-screen w-full bg-white font-sans">
    <aside class="flex w-64 shrink-0 flex-col border-r border-gray-200 bg-white">
        <div class="flex h-16 shrink-0 items-center gap-3 border-b border-gray-200 px-6">
            <a href="/chat" class="flex items-center gap-3">
                <div class="flex h-8 w-8 items-center justify-center rounded-lg bg-[#13a4ec] text-white">
                    <span class="material-symbols-outlined text-xl">health_and_safety</span>
                </div>
                <h1 class="text-xl font-bold text-[#1e293b]">Internist AI</h1>
            </a>
        </div>
        <div class="flex flex-1 flex-col overflow-y-auto p-4">
            <button id="new-chat-btn" class="mb-4 flex w-full items-center justify-center gap-2 rounded-md border border-gray-300 px-3 py-2 text-sm font-medium text-[#1e293b] hover:bg-gray-100">
                <span class="material-symbols-outlined text-lg">add</span>
                New Chat
            </button>
            <nav id="chat-list-container" class="flex flex-col">
                <h2 class="mb-2 text-xs font-semibold uppercase text-[#64748b]">Previous Chats</h2>
                {{range .Chats}}
                <div class="group mt-1 flex items-center justify-between gap-3 rounded-md px-3 py-2 hover:bg-gray-100 {{if eq .ID $.ActiveChatID}}bg-gray-100{{end}}" data-chat-item-id="{{.ID}}">
                    <a class="flex items-center gap-3 truncate w-full" href="/chat?id={{.ID}}">
                        <span class="material-symbols-outlined text-lg text-[#64748b]">chat_bubble</span>
                        <span class="truncate">{{.Title}}</span>
                    </a>
                    <button class="delete-chat-btn flex h-6 w-6 shrink-0 items-center justify-center rounded-md text-gray-500 opacity-0 group-hover:opacity-100 hover:bg-gray-200 hover:text-gray-800"
                            data-chat-id="{{.ID}}"
                            title="Delete chat">
                        <span class="material-symbols-outlined text-base">delete</span>
                    </button>
                </div>
                {{end}}
            </nav>
        </div>
        <div id="balance-container" class="border-t border-gray-200 p-4">
            <div class="rounded-lg bg-gray-100 p-3">
                <div class="flex justify-between text-xs font-medium text-[#64748b]">
                    <span>Credits Remaining</span>
                    <span>{{.User.CharacterBalance}} / {{.User.TotalCharacterBalance}}</span>
                </div>
                <div class="mt-1 h-2 w-full rounded-full bg-gray-300">
                    <div class="h-2 rounded-full bg-[#13a4ec]" style="width: {{percentage .User.CharacterBalance .User.TotalCharacterBalance}}%;"></div>
                </div>
            </div>
        </div>
    </aside>

    <div class="flex h-screen w-full flex-col">
        <header class="flex h-16 shrink-0 items-center justify-end border-b border-gray-200 bg-white px-6">
            <div class="flex items-center gap-4">
                <span class="text-sm font-medium text-gray-700">{{.User.Username}}</span>
                <a href="/logout" title="Logout" class="flex h-10 w-10 items-center justify-center rounded-full text-[#64748b] hover:bg-gray-100">
                    <span class="material-symbols-outlined text-2xl">logout</span>
                </a>
            </div>
        </header>
        <main class="flex flex-1 flex-col overflow-y-auto bg-[#f8fafc]">
            <div id="message-container" class="mx-auto w-full max-w-4xl flex-1 px-4 py-8 sm:px-6 lg:px-8">
                <div class="space-y-8">
                    {{if not .Messages}}
                    <div class="text-center flex flex-col items-center gap-4 mt-16" id="welcome-message">
                        <h2 class="text-3xl font-bold text-[#1e293b]">Welcome, {{.User.Username}}</h2>
                        <p class="text-[#64748b]">Select a conversation from the sidebar or start a new one.</p>
                    </div>
                    {{end}}
                    {{range .Messages}}
                        {{if eq .MessageType "assistant"}}
                        <div class="flex items-start gap-3 group">
                            <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-full bg-gray-200">
                                <span class="material-symbols-outlined text-[#64748b]">smart_toy</span>
                            </div>
                            <div class="flex-1">
                                <p class="text-sm font-medium text-[#64748b]">Internist AI</p>
                                <div class="relative mt-1">
                                    <div class="message-content prose prose-lg rounded-lg rounded-tl-none bg-gray-100 p-3 text-base text-[#1e293b]">{{.RenderedContent}}</div>
                                    <button onclick="exportMessageAsPDF(this.parentElement.querySelector('.message-content').innerHTML)" class="absolute top-1 right-1 opacity-0 group-hover:opacity-100 transition-opacity bg-white p-1 rounded-full shadow-sm hover:bg-gray-200">
                                        <span class="material-symbols-outlined text-base text-gray-600">picture_as_pdf</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                        {{else if eq .MessageType "user"}}
                        <div class="flex items-start justify-end gap-3">
                            <div class="flex flex-col items-end">
                                <p class="text-right text-sm font-medium text-[#64748b]">{{$.User.Username}}</p>
                                <div class="message-content mt-1 rounded-lg rounded-tr-none bg-[#13a4ec] p-3 text-base text-white">{{.Content}}</div>
                            </div>
                        </div>
                        {{end}}
                    {{end}}
                </div>
            </div>
            <div class="sticky bottom-0 bg-[#f8fafc]/80 backdrop-blur-sm">
                 <div class="mx-auto w-full max-w-4xl px-4 py-4 sm:px-6 lg:px-8">
                    {{if gt .User.CharacterBalance 0}}
                        <form id="chat-form" class="relative">
                            <input id="message-input" class="w-full rounded-full border-gray-300 bg-[#f1f5f9] py-3 pl-5 pr-14 text-base text-[#1e293b] placeholder:text-[#64748b] focus:border-[#13a4ec] focus:ring-[#13a4ec]" placeholder="Type your message here..." type="text" autocomplete="off" />
                            <button id="send-button" type="submit" class="absolute inset-y-0 right-3 flex h-8 w-8 my-auto items-center justify-center rounded-full bg-[#13a4ec] text-white hover:bg-opacity-90">
                                <span class="material-symbols-outlined text-xl">send</span>
                            </button>
                        </form>
                    {{else}}
                        <div class="flex items-center justify-between rounded-full border border-gray-300 bg-gray-100 p-2 pl-5">
                            <p class="text-sm font-medium text-gray-500">You have run out of credits.</p>
                            <a href="https://t.me/internist_support" target="_blank" rel="noopener noreferrer" class="inline-flex items-center gap-2 rounded-full bg-green-500 px-4 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-green-600">
                                <span class="material-symbols-outlined text-base">contact_support</span>
                                <span>Contact Support</span>
                            </a>
                        </div>
                    {{end}}
                </div>
            </div>
        </main>
    </div>
</div>

<div id="delete-confirm-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-gray-900 bg-opacity-50 backdrop-blur-sm hidden">
    <div class="w-full max-w-md rounded-lg bg-white p-6 shadow-xl">
        <div class="flex items-start">
            <div class="flex h-12 w-12 shrink-0 items-center justify-center rounded-full bg-red-100 sm:h-10 sm:w-10">
                <span class="material-symbols-outlined text-red-600">warning</span>
            </div>
            <div class="ml-4 text-left">
                <h3 class="text-lg font-semibold leading-6 text-gray-900">Delete Chat</h3>
                <div class="mt-2">
                    <p class="text-sm text-gray-500">Are you sure you want to delete this chat? This action cannot be undone.</p>
                </div>
            </div>
        </div>
        <div class="mt-5 sm:mt-4 sm:flex sm:flex-row-reverse">
            <button id="modal-confirm-delete-btn" type="button" class="inline-flex w-full justify-center rounded-md bg-red-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-red-500 sm:ml-3 sm:w-auto">Delete</button>
            <button id="modal-cancel-btn" type="button" class="mt-3 inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 sm:mt-0 sm:w-auto">Cancel</button>
        </div>
    </div>
</div>
{{end}}

{{define "scripts"}}
<script>
    window.INTERNIST_DATA = {
        currentUsername: {{.User.Username | json}},
        activeChatID: {{.ActiveChatID}},
        userBalance: {{.User.CharacterBalance}},
        totalBalance: {{.User.TotalCharacterBalance}}
    };
</script>
<script src="/static/js/chat.js" defer></script>
{{end}}
