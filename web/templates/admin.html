{{define "title"}}Internist AI - Admin Panel{{end}}

{{define "content"}}
<body class="bg-gray-50">
<div class="flex h-full min-h-screen w-full">
    <aside class="flex w-64 flex-col border-r border-gray-200 bg-white">
        <div class="flex h-16 shrink-0 items-center justify-start border-b border-gray-200 px-6">
            <a href="/admin" class="text-xl font-bold text-gray-800">Internist AI</a>
        </div>
        <nav class="flex-1 space-y-2 overflow-y-auto p-4">
            <a class="flex items-center gap-3 rounded-md bg-primary-50 px-3 py-2 text-primary-700" href="/admin">
                <span class="material-symbols-outlined">group</span>
                <span class="text-sm font-medium">Users</span>
            </a>
             <a class="flex items-center gap-3 rounded-md px-3 py-2 text-gray-600 hover:bg-gray-100" href="#">
                <span class="material-symbols-outlined text-gray-500">analytics</span>
                <span class="text-sm font-medium">Analytics</span>
            </a>
        </nav>
        <div class="border-t border-gray-200 p-4">
             <a class="flex items-center gap-3 rounded-md px-3 py-2 text-gray-600 hover:bg-gray-100" href="/logout">
                <span class="material-symbols-outlined text-gray-500">logout</span>
                <span class="text-sm font-medium">Logout</span>
            </a>
        </div>
    </aside>
    <main class="flex-1">
        <div class="border-b border-gray-200 bg-white">
            <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
                <div class="flex h-16 items-center justify-between">
                    <h2 class="text-2xl font-bold leading-tight text-gray-900">Users</h2>
                    <div>
                        <a href="/api/admin/users/export" class="mr-2 inline-flex items-center justify-center gap-2 rounded-md bg-white px-4 py-2 text-sm font-semibold text-gray-700 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
                            <span class="material-symbols-outlined text-base">download</span>
                            <span>Export CSV</span>
                        </a>
                        <button id="add-user-btn" class="inline-flex items-center justify-center gap-2 rounded-md bg-primary-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-primary-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary-600">
                            <span class="material-symbols-outlined text-base">add</span>
                            <span>Add User</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div class="mx-auto max-w-7xl py-6 sm:px-6 lg:px-8">
            <div class="space-y-6">
                <div class="rounded-lg border border-gray-200 bg-white shadow-sm">
                    <div class="p-4 sm:p-6">
                        <div class="relative w-full sm:max-w-xs">
                            <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
                                <span class="material-symbols-outlined text-gray-400">search</span>
                            </div>
                            <input id="search-input" class="block w-full rounded-md border-0 py-2 pl-10 text-gray-900 ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-primary-600 sm:text-sm sm:leading-6" placeholder="Search by username or phone" type="search"/>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500" scope="col">Username</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500" scope="col">Phone Number</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500" scope="col">Credits Balance</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500" scope="col">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500" scope="col">Role</th>
                                    <th class="relative px-6 py-3" scope="col"><span class="sr-only">Actions</span></th>
                                </tr>
                            </thead>
                            <tbody id="user-table-body" class="divide-y divide-gray-200 bg-white">
                                {{range .Users}}
                                <tr>
                                    <td class="whitespace-nowrap px-6 py-4 text-sm font-medium text-gray-900">{{.Username}}</td>
                                    <td class="whitespace-nowrap px-6 py-4 text-sm text-gray-500">{{.PhoneNumber}}</td>
                                    <td class="whitespace-nowrap px-6 py-4 text-sm text-gray-500">{{.CharacterBalance}}</td>
                                    <td class="whitespace-nowrap px-6 py-4 text-sm text-gray-500">
                                        {{if eq .Status "active"}}
                                            <span class="inline-flex items-center rounded-full bg-green-100 px-2.5 py-0.5 text-xs font-medium text-green-800">Active</span>
                                        {{else}}
                                            <span class="inline-flex items-center rounded-full bg-yellow-100 px-2.5 py-0.5 text-xs font-medium text-yellow-800">Pending</span>
                                        {{end}}
                                    </td>
                                    <td class="whitespace-nowrap px-6 py-4 text-sm">
                                        {{if .IsAdmin}}
                                            <span class="inline-flex items-center rounded-full bg-red-100 px-2.5 py-0.5 text-xs font-medium text-red-800">Admin</span>
                                        {{else}}
                                            <span class="inline-flex items-center rounded-full bg-blue-100 px-2.5 py-0.5 text-xs font-medium text-blue-800">User</span>
                                        {{end}}
                                    </td>
                                    <td class="whitespace-nowrap px-6 py-4 text-right text-sm font-medium">
                                        <button class="font-medium text-primary-600 hover:text-primary-900" 
                                                data-action="add-credits" 
                                                data-userid="{{.ID}}" 
                                                data-username="{{.Username}}">
                                            Add Credits
                                        </button>
                                    </td>
                                </tr>
                                {{end}}
                            </tbody>
                        </table>
                    </div>
                    <div id="pagination-container" class="flex items-center justify-between border-t border-gray-200 bg-white px-4 py-3 sm:px-6">
                        </div>
                </div>
            </div>
        </div>
    </main>
</div>
</body>
{{end}}

{{define "scripts"}}
<script>
    // --- DOM Elements ---
    const searchInput = document.getElementById('search-input');
    const userTableBody = document.getElementById('user-table-body');
    const paginationContainer = document.getElementById('pagination-container');
    let currentSearch = '';
    let debounceTimer;

    // --- Core Function to Fetch and Render Users ---
    async function fetchAndRenderUsers(page = 1, search = '') {
        try {
            const response = await fetch(`/api/admin/users?page=${page}&search=${search}`);
            if (!response.ok) throw new Error('Failed to fetch users');
            const data = await response.json();
            renderTable(data.users);
            renderPagination(data.total, data.page, data.limit);
        } catch (error) {
            console.error("Error fetching users:", error);
            userTableBody.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-red-500">Failed to load users.</td></tr>`;
        }
    }

    // --- Render Functions ---
    function renderTable(users) {
        userTableBody.innerHTML = '';
        if (!users || users.length === 0) {
            userTableBody.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-gray-500">No users found.</td></tr>`;
            return;
        }
        users.forEach(user => {
            const row = `
                <tr>
                    <td class="whitespace-nowrap px-6 py-4 text-sm font-medium text-gray-900">${user.username}</td>
                    <td class="whitespace-nowrap px-6 py-4 text-sm text-gray-500">${user.phone_number}</td>
                    <td class="whitespace-nowrap px-6 py-4 text-sm text-gray-500">${user.character_balance}</td>
                    <td class="whitespace-nowrap px-6 py-4 text-sm text-gray-500">
                        ${user.status === 'active' 
                            ? `<span class="inline-flex items-center rounded-full bg-green-100 px-2.5 py-0.5 text-xs font-medium text-green-800">Active</span>`
                            : `<span class="inline-flex items-center rounded-full bg-yellow-100 px-2.5 py-0.5 text-xs font-medium text-yellow-800">Pending</span>`
                        }
                    </td>
                    <td class="whitespace-nowrap px-6 py-4 text-sm">
                        ${user.isAdmin 
                            ? `<span class="inline-flex items-center rounded-full bg-red-100 px-2.5 py-0.5 text-xs font-medium text-red-800">Admin</span>`
                            : `<span class="inline-flex items-center rounded-full bg-blue-100 px-2.5 py-0.5 text-xs font-medium text-blue-800">User</span>`
                        }
                    </td>
                    <td class="whitespace-nowrap px-6 py-4 text-right text-sm font-medium">
                        <button class="font-medium text-primary-600 hover:text-primary-900" 
                                data-action="add-credits" 
                                data-userid="${user.id}" 
                                data-username="${user.username}">
                            Add Credits
                        </button>
                    </td>
                </tr>
            `;
            userTableBody.innerHTML += row;
        });
    }

    function renderPagination(total, page, limit) {
        const totalPages = Math.ceil(total / limit);
        paginationContainer.innerHTML = `
            <div>
                <p class="text-sm text-gray-700">
                    Showing <span class="font-medium">${(page - 1) * limit + 1}</span>
                    to <span class="font-medium">${Math.min(page * limit, total)}</span>
                    of <span class="font-medium">${total}</span> results
                </p>
            </div>
            <div>
                 <p class="text-sm text-gray-700">Page ${page} of ${totalPages}</p>
            </div>
        `;
    }

    // --- Event Listeners ---
    searchInput.addEventListener('input', (e) => {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
            currentSearch = e.target.value;
            fetchAndRenderUsers(1, currentSearch);
        }, 300);
    });

    userTableBody.addEventListener('click', (e) => {
        const target = e.target;
        if (target.dataset.action === 'add-credits') {
            const userId = target.dataset.userid;
            const username = target.dataset.username;
            handleAddCredits(userId, username);
        }
    });

    // CORRECTED: Removed the duplicate function
    async function handleAddCredits(userId, username) {
        const amountStr = prompt(`How many credits would you like to add to ${username}?`);
        if (amountStr) {
            const amount = parseInt(amountStr, 10);
            if (isNaN(amount) || amount <= 0) {
                alert('Please enter a valid positive number.');
                return;
            }
            try {
                const response = await fetch('/api/admin/users/topup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userID: parseInt(userId), amount: amount })
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to add credits');
                }
                alert(`Successfully added ${amount} credits to ${username}.`);
                fetchAndRenderUsers(1, currentSearch);
            } catch (error) {
                console.error('Error adding credits:', error);
                alert(`Error: ${error.message}`);
            }
        }
    }
</script>
{{end}}